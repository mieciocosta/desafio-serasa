Anderson, segue abaixo os cenários que montei para a HU 74373. Estão focados no comportamento do worker do MED/SIGCN (consumo do endpoint do SISPI + aplicação de filtros + persistência + envio ao Service Bus/SICLON), não em testar o endpoint isoladamente:

CT01 – Processar relatos abertos (RECEBIDA/OPEN) com sucesso (Worker HU 74373)
Dado que o endpoint do SISPI retorne relatos com tipoOrigemRelatoInfracao=RECEBIDA e statusRelatoInfracao=OPEN
Quando o worker do SIGCN/MED executar a rotina de consulta
Então os relatos devem ser gravados no CosmosDB
E devem ser postados na fila do Service Bus para o SICLON
E o processamento deve ser registrado com sucesso

CT02 – Resposta sem itens elegíveis (Worker HU 74373)
Dado que o endpoint retorne vazio ou sem itens OPEN/RECEBIDA
Quando o worker executar a rotina
Então não deve gravar registros
E não deve postar mensagens na fila

CT03 – Agendamento (Worker HU 74373)
Dado que o agendamento esteja ativo
Quando completar 1 hora
Então o worker deve executar novamente e processar conforme regras

CT04 – Falha no consumo do SISPI (Worker HU 74373)
Dado que o endpoint retorne erro (ex: 500/timeout)
Quando o worker executar
Então deve registrar o erro (telemetria/log)
E não deve gravar nem postar

CT05 – Idempotência por ID fim a fim (Worker HU 74373)
Dado que já exista registro com o mesmo ID fim a fim
Quando o worker receber o mesmo item novamente
Então não deve duplicar no Cosmos
E não deve reenviar ao SICLON

CT06 – Postagem no Service Bus com sucesso (Worker HU 74373)
Dado que há itens gravados e elegíveis
Quando o worker postar na fila
Então registrar sucesso e disponibilizar para consumo do SICLON

CT07 – Falha ao postar na fila (Worker HU 74373)
Dado que o Service Bus esteja indisponível
Quando o worker tentar postar
Então registrar erro
E manter o item disponível para reprocessamento



Paulo, entendido. Os cenários que levantei são para validar o worker end-to-end da HU 74373 (após ele estar completo), cobrindo filtros RECEBIDA/OPEN, gravação no Cosmos, idempotência por ID fim a fim, envio ao Service Bus e registro de erro. Não é teste do endpoint do SISPI isoladamente. Assim que o worker estiver com as informações do Moreno, executo a validação.


